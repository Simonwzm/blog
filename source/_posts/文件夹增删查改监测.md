---
title: 文件夹增删查改监测
date: 2023-06-27 10:05
tags: 
decsription:
cover: "https://s2.loli.net/2023/08/05/sawA4GiXp93Pntg.jpg"
---


# 文件夹增删查改监测

本次任务需要监测源文件夹中发生的增删查改的情况，在出现上述操作时，将复制完或者改完的样本再到目的文件夹中（使用 shutil 库）。

使用到的第三方库有 watchdog shutil subprocess 等

主要核心代码为：

```python
class MyHandler(FileSystemEventHandler):
    def __init__(self, src_dir, dst_dir):
        self.src_dir = src_dir
        self.dst_dir = dst_dir

    def on_modified(self, event):
        if not event.is_directory:
            if not os.path.basename(event.src_path).startswith('.'):
                print(f'Modified: {event.src_path}')
                shutil.copy2(event.src_path, os.path.join(self.dst_dir, os.path.basename(event.src_path)))
                self.deploy_blog()

    def on_created(self, event):
        if not event.is_directory:
            if not os.path.basename(event.src_path).startswith('.'):
                print(f'Created: {event.src_path}')
                shutil.copy2(event.src_path, os.path.join(self.dst_dir, os.path.basename(event.src_path)))
                self.deploy_blog()


if __name__ == "__main__":
    src_path = r"D:\Simon\Program_Files\dropbox_sync\Dropbox\Sync\ObNotes\03 Knowledge\blog_posts"
    dst_path = r"D:\Simon\Dev\blog\source\_posts"

    event_handler = MyHandler(src_path, dst_path)
    observer = Observer()
    observer.schedule(event_handler, src_path, recursive=True)
    observer.start()

    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        observer.stop()
    observer.join()
```

然后运行 nssm 服务将其注册为
后台运行的服务。最后使用`./nssm start <service>`就可以了。

## nssm 介绍

nssm可以简单暴力地将任何脚本转换为windows服务。下载地址为[这里](app://obsidian.md/www.nssm.cc) , 解压文件可以得到exe文件。其具有cli界面，可以完整而方便地选择服务使用的各种参数，比如输入输出流，解释器位置，运行环境，优先级等等。

![nssm example](https://s2.loli.net/2023/06/27/vUEji3MIpPWo1JO.png)

一旦注册完毕，使用

```powershell
./nssm start <service>
./nssm edit <service>
./nssm stop <service>
```

来控制服务的开始和停止。

